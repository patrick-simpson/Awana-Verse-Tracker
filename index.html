<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awana Africa Verse Tracker</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        awana: {
                            green: '#48a23f',
                            yellow: '#fcd116',
                            blue: '#00a3e0',
                        }
                    },
                    fontFamily: {
                        display: ['"Luckiest Guy"', 'cursive'],
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    animation: {
                        'gradient-x': 'gradient-x 15s ease infinite',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size': '200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size': '200% 200%',
                                'background-position': 'right center'
                            },
                        },
                    },
                }
            }
        }
    </script>

    <!-- Import Map for React & Libraries -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom",
        "canvas-confetti": "https://esm.sh/canvas-confetti@1.6.0"
      }
    }
    </script>

    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #00a3e0;
        }

        /* Animated Background Gradient */
        .brand-gradient {
            background: linear-gradient(-45deg, #48a23f, #00a3e0, #fcd116, #48a23f);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* TV Broadcast Number Styling */
        .broadcast-number {
            -webkit-text-stroke: 6px white; /* Fallback */
            text-shadow: 
                0px 4px 0px #00000020,
                0px 8px 10px #00000050;
            paint-order: stroke fill;
        }

        /* Custom Stroke utility for Tailwind doesn't always work perfectly with text, using CSS */
        .text-stroke-white {
            -webkit-text-stroke: 4px white;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { motion, AnimatePresence } from 'framer-motion';
        import confetti from 'canvas-confetti';

        // --- AUDIO ENGINE (Web Audio API) ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }
            }

            playTone(freq, type, duration, startTime = 0) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime + startTime);
                
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime + startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + startTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start(this.ctx.currentTime + startTime);
                osc.stop(this.ctx.currentTime + startTime + duration);
            }

            playPop() {
                this.init();
                // A chirpy sine wave
                this.playTone(880, 'sine', 0.1); // A5
                setTimeout(() => this.playTone(1760, 'sine', 0.1), 50); // A6 quickly after
            }

            playMilestone() {
                this.init();
                // C Major Triad Arpeggio (C5, E5, G5)
                const now = this.ctx.currentTime;
                this.playTone(523.25, 'triangle', 0.6, 0);    // C
                this.playTone(659.25, 'triangle', 0.6, 0.1);  // E
                this.playTone(783.99, 'triangle', 1.0, 0.2);  // G
                
                // Add a bass root
                this.playTone(261.63, 'sine', 1.2, 0); // C4
            }
        }

        const audio = new AudioEngine();

        // --- HOOKS ---
        
        const usePresence = (bucketKey) => {
            const [activeCount, setActiveCount] = useState(1);
            const sessionId = useRef(Math.random().toString(36).substring(2, 15)).current;

            useEffect(() => {
                if (!bucketKey) return;

                const heartbeat = async () => {
                    try {
                        // Set TTL to 12 seconds, ping every 5. 
                        // This indicates this device is active.
                        await fetch(`https://kvdb.io/${bucketKey}/ping:${sessionId}?ttl=12`, {
                            method: 'POST',
                            body: '1'
                        });
                    } catch (e) { console.error('Heartbeat fail', e); }
                };

                const checkPeers = async () => {
                    try {
                        const res = await fetch(`https://kvdb.io/${bucketKey}/?prefix=ping:`);
                        if (res.ok) {
                            const text = await res.text();
                            // Split by newline and filter empty strings to get key list
                            const keys = text.split('\n').filter(k => k.trim().length > 0);
                            setActiveCount(keys.length);
                        }
                    } catch (e) { console.error('Peer check fail', e); }
                };

                // Initial run
                heartbeat();
                checkPeers();

                const pingInterval = setInterval(heartbeat, 5000);
                const checkInterval = setInterval(checkPeers, 10000); // Check peers every 10s

                return () => {
                    clearInterval(pingInterval);
                    clearInterval(checkInterval);
                };
            }, [bucketKey]);

            return activeCount;
        };

        // --- COMPONENTS ---

        // 1. Setup Screen
        const SetupScreen = ({ onComplete }) => {
            const [key, setKey] = useState('');
            const [email, setEmail] = useState('');
            const [mode, setMode] = useState('login'); // login | generate
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [successMsg, setSuccessMsg] = useState('');

            // Load saved key
            useEffect(() => {
                const savedKey = localStorage.getItem('awana_verse_key');
                if (savedKey) setKey(savedKey);
            }, []);

            const generateKey = async (e) => {
                e.preventDefault();
                if (!email || !email.includes('@')) {
                    setError('Please enter a valid email address.');
                    return;
                }
                
                setIsLoading(true);
                setError('');
                
                try {
                    // KVDB requires an email parameter in the body
                    const formData = new URLSearchParams();
                    formData.append('email', email);

                    const res = await fetch('https://kvdb.io/', { 
                        method: 'POST',
                        body: formData
                    });

                    if (res.ok) {
                        const newKey = await res.text();
                        setKey(newKey.trim());
                        setSuccessMsg('‚ú® Success! Your new secret key is ready.');
                        setMode('login');
                        // Save email for next time? Maybe not necessary for this session.
                    } else {
                        const txt = await res.text();
                        setError('Failed to generate: ' + txt);
                    }
                } catch (e) {
                    setError('Connection error. Please check your internet.');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleSubmit = (appMode) => {
                if (key.length < 3) {
                    setError('Please enter a valid Secret Key');
                    return;
                }
                localStorage.setItem('awana_verse_key', key.trim());
                audio.init();
                onComplete(key.trim(), appMode);
            };

            return (
                <div className="min-h-screen brand-gradient flex items-center justify-center p-4">
                    <motion.div 
                        initial={{ opacity: 0, y: 20 }}
                        animate={{ opacity: 1, y: 0 }}
                        className="glass-panel rounded-3xl p-6 md:p-8 max-w-md w-full text-center relative overflow-hidden"
                    >
                        {/* Header */}
                        <img 
                            src="logo.png" 
                            onError={(e) => e.target.style.display='none'} 
                            alt="Awana Africa" 
                            className="h-20 mx-auto mb-4 object-contain"
                        />
                        <h1 className="font-display text-4xl text-awana-blue mb-1 text-stroke-white drop-shadow-md">
                            Verse Tracker
                        </h1>
                        <p className="text-gray-600 mb-6 font-sans text-sm">
                            {mode === 'login' ? 'Sync your TV Display and Remote' : 'Create a New Sync Key'}
                        </p>

                        <AnimatePresence mode="wait">
                            {mode === 'login' ? (
                                <motion.div 
                                    key="login"
                                    initial={{ x: -20, opacity: 0 }}
                                    animate={{ x: 0, opacity: 1 }}
                                    exit={{ x: -20, opacity: 0 }}
                                    className="text-left"
                                >
                                    <div className="bg-white/60 p-4 rounded-xl border border-white/50 shadow-inner mb-6">
                                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">
                                            Church Secret Key
                                        </label>
                                        
                                        <input
                                            type="text"
                                            value={key}
                                            onChange={(e) => {setKey(e.target.value); setError(''); setSuccessMsg('');}}
                                            placeholder="Paste Key Here..."
                                            className="w-full text-center font-mono text-lg font-bold p-3 rounded-lg border-2 border-awana-yellow focus:border-awana-green focus:outline-none bg-white mb-2"
                                        />
                                        
                                        {successMsg && <p className="text-green-600 text-xs font-bold text-center mb-2 animate-bounce">{successMsg}</p>}

                                        <div className="text-center">
                                            <button 
                                                onClick={() => {setMode('generate'); setError('');}} 
                                                className="text-awana-blue hover:text-blue-700 text-xs font-bold underline"
                                            >
                                                No key? Generate one here.
                                            </button>
                                        </div>
                                    </div>

                                    {error && <p className="text-red-500 text-sm mb-4 text-center bg-red-50 p-2 rounded border border-red-200">{error}</p>}

                                    <div className="grid grid-cols-1 gap-3">
                                        <button 
                                            onClick={() => handleSubmit('display')}
                                            className="bg-awana-green hover:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-[1.02] active:scale-95 text-lg flex items-center justify-center gap-2"
                                        >
                                            <span>üì∫</span> Start Sanctuary Display
                                        </button>
                                        <button 
                                            onClick={() => handleSubmit('admin')}
                                            className="bg-awana-blue hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transform transition hover:scale-[1.02] active:scale-95 text-lg flex items-center justify-center gap-2"
                                        >
                                            <span>üì±</span> Open Remote Control
                                        </button>
                                    </div>
                                </motion.div>
                            ) : (
                                <motion.div 
                                    key="generate"
                                    initial={{ x: 20, opacity: 0 }}
                                    animate={{ x: 0, opacity: 1 }}
                                    exit={{ x: 20, opacity: 0 }}
                                    className="text-left"
                                >
                                    <form onSubmit={generateKey} className="bg-white/60 p-4 rounded-xl border border-white/50 shadow-inner mb-6">
                                        <label className="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">
                                            Enter Your Email
                                        </label>
                                        <p className="text-[10px] text-gray-500 mb-2">Required by KVDB.io to assign a unique key.</p>
                                        
                                        <input
                                            type="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            placeholder="you@church.org"
                                            className="w-full font-sans text-md font-semibold p-3 rounded-lg border-2 border-awana-yellow focus:border-awana-green focus:outline-none bg-white mb-4"
                                            autoFocus
                                        />

                                        <button 
                                            type="submit"
                                            disabled={isLoading}
                                            className="w-full bg-awana-yellow hover:bg-yellow-400 text-yellow-900 font-bold py-3 rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {isLoading ? 'Generating...' : '‚ú® Generate Key'}
                                        </button>
                                    </form>

                                    {error && <p className="text-red-500 text-sm mb-4 text-center bg-red-50 p-2 rounded border border-red-200">{error}</p>}

                                    <div className="text-center">
                                        <button 
                                            onClick={() => {setMode('login'); setError('');}} 
                                            className="text-gray-500 hover:text-gray-700 font-semibold text-sm"
                                        >
                                            Cancel / Go Back
                                        </button>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </motion.div>
                </div>
            );
        };

        // 2. Display Mode
        const DisplayMode = ({ bucketKey }) => {
            const [count, setCount] = useState(0);
            const [status, setStatus] = useState('connecting'); // connecting, online, offline
            const prevCountRef = useRef(0);
            const isFirstLoad = useRef(true);
            
            // Use Presence Hook
            const peerCount = usePresence(bucketKey);

            const fetchData = async () => {
                try {
                    // Cache busting with timestamp
                    const res = await fetch(`https://kvdb.io/${bucketKey}/verses?t=${Date.now()}`, {
                        cache: 'no-store'
                    });
                    
                    if (res.status === 404) {
                        setCount(0);
                        setStatus('online');
                        return;
                    }

                    if (!res.ok) throw new Error('Network response was not ok');

                    const text = await res.text();
                    const newCount = parseInt(text, 10) || 0;
                    
                    setStatus('online');
                    
                    // Logic for effects
                    if (!isFirstLoad.current && newCount > prevCountRef.current) {
                        // Trigger effects
                        handleIncrease(newCount);
                    }
                    
                    prevCountRef.current = newCount;
                    if(isFirstLoad.current) {
                        setCount(newCount);
                        isFirstLoad.current = false;
                    } else {
                        setCount(newCount);
                    }

                } catch (err) {
                    console.error("Poll error:", err);
                    setStatus('offline');
                }
            };

            const handleIncrease = (val) => {
                // Audio
                if (val % 25 === 0) {
                    audio.playMilestone();
                    // Mega Confetti
                    confetti({
                        particleCount: 150,
                        spread: 100,
                        origin: { y: 0.6 },
                        colors: ['#48a23f', '#fcd116', '#00a3e0']
                    });
                } else {
                    audio.playPop();
                    // Small Confetti Burst
                    confetti({
                        particleCount: 30,
                        spread: 50,
                        origin: { y: 0.5 },
                        colors: ['#48a23f', '#fcd116', '#00a3e0']
                    });
                }
            };

            // Polling Effect
            useEffect(() => {
                fetchData(); // Initial fetch
                const interval = setInterval(fetchData, 5000);
                return () => clearInterval(interval);
            }, [bucketKey]);

            return (
                <div className="relative min-h-screen brand-gradient flex flex-col items-center justify-center overflow-hidden">
                    {/* Background Overlay Image (Optional) */}
                    <div 
                        className="absolute inset-0 opacity-10 bg-center bg-cover pointer-events-none mix-blend-overlay"
                        style={{ backgroundImage: 'url(background.jpg)' }}
                    ></div>

                    {/* Connection Status */}
                    <div className="absolute top-6 right-6 flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full transition-all">
                        <div className={`w-3 h-3 rounded-full ${status === 'online' ? 'bg-green-400 animate-pulse' : 'bg-red-500'}`}></div>
                        <span className="text-white text-xs font-bold uppercase tracking-wider">
                            {status === 'online' ? `Live ‚Ä¢ ${peerCount} Connected` : 'Offline'}
                        </span>
                    </div>

                    {/* Branding */}
                    <div className="absolute top-6 left-6">
                        <img src="logo.png" onError={(e) => e.target.style.display='none'} className="h-16 w-auto drop-shadow-lg" />
                    </div>

                    {/* Main Counter */}
                    <div className="relative z-10 text-center">
                        <motion.h2 
                            className="text-white font-display text-4xl md:text-6xl mb-4 tracking-wide uppercase drop-shadow-md opacity-90"
                            initial={{ y: -50, opacity: 0 }}
                            animate={{ y: 0, opacity: 1 }}
                        >
                            Verses Recited
                        </motion.h2>
                        
                        <AnimatePresence mode="wait">
                            <motion.div
                                key={count}
                                initial={{ scale: 0.5, opacity: 0 }}
                                animate={{ scale: 1, opacity: 1 }}
                                exit={{ scale: 1.5, opacity: 0, position: 'absolute' }}
                                transition={{ type: "spring", stiffness: 300, damping: 15 }}
                                className="relative"
                            >
                                <span className="font-display text-[12rem] md:text-[20rem] leading-none text-awana-yellow broadcast-number drop-shadow-2xl filter">
                                    {count}
                                </span>
                            </motion.div>
                        </AnimatePresence>
                    </div>

                    {/* Footer decoration */}
                    <div className="absolute bottom-0 w-full h-24 bg-gradient-to-t from-black/20 to-transparent"></div>
                </div>
            );
        };

        // 3. Admin Mode
        const AdminMode = ({ bucketKey, onLogout }) => {
            const [count, setCount] = useState(0);
            const [loading, setLoading] = useState(false);
            const [confirmReset, setConfirmReset] = useState(false);
            
            // Hook in presence so the Admin remote also counts as a connected device
            const peerCount = usePresence(bucketKey);

            // Fetch current state
            const sync = useCallback(async () => {
                try {
                    const res = await fetch(`https://kvdb.io/${bucketKey}/verses?t=${Date.now()}`);
                    if (res.ok) {
                        const text = await res.text();
                        setCount(parseInt(text, 10) || 0);
                    } else if (res.status === 404) {
                        setCount(0);
                    }
                } catch (e) {
                    console.error(e);
                }
            }, [bucketKey]);

            useEffect(() => {
                sync();
            }, [sync]);

            const updateCount = async (newVal) => {
                setLoading(true);
                // Optimistic update
                setCount(newVal);
                
                try {
                    await fetch(`https://kvdb.io/${bucketKey}/verses`, {
                        method: 'POST', // kvdb uses POST/PUT for setting values
                        body: newVal.toString()
                    });
                } catch (e) {
                    alert("Failed to sync. Check connection.");
                    sync(); // Revert on failure
                } finally {
                    setLoading(false);
                }
            };

            const adjust = (delta) => {
                const newVal = Math.max(0, count + delta);
                updateCount(newVal);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col items-center p-6">
                    <div className="w-full max-w-lg">
                        <div className="flex justify-between items-center mb-8">
                            <button onClick={onLogout} className="text-gray-500 hover:text-gray-800 font-semibold">
                                ‚Üê Exit
                            </button>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded">
                                    {peerCount} active
                                </span>
                                <div className={`w-2 h-2 rounded-full ${loading ? 'bg-yellow-500' : 'bg-green-500'}`}></div>
                                <span className="text-xs text-gray-400 uppercase">{loading ? 'Syncing...' : 'Synced'}</span>
                            </div>
                        </div>

                        <div className="bg-white rounded-3xl shadow-xl p-8 text-center border border-gray-100">
                            <h2 className="text-gray-400 font-bold uppercase tracking-widest text-sm mb-4">Current Count</h2>
                            <div className="font-display text-8xl text-awana-blue mb-8">{count}</div>

                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <button 
                                    onClick={() => adjust(-1)}
                                    className="bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-6 rounded-2xl text-xl transition active:scale-95"
                                >
                                    -1
                                </button>
                                <button 
                                    onClick={() => adjust(1)}
                                    className="bg-awana-green hover:bg-green-600 text-white font-bold py-6 rounded-2xl text-3xl shadow-lg shadow-green-200 transition transform active:scale-95 col-span-2"
                                >
                                    +1 Verse
                                </button>
                            </div>
                            
                            <button 
                                onClick={() => adjust(5)}
                                className="w-full bg-awana-yellow hover:bg-yellow-400 text-yellow-900 font-bold py-6 rounded-2xl text-2xl shadow-lg shadow-yellow-100 transition transform active:scale-95 mb-8"
                            >
                                +5 Verses
                            </button>

                            <div className="border-t pt-6">
                                {!confirmReset ? (
                                    <button 
                                        onClick={() => setConfirmReset(true)}
                                        className="text-red-400 hover:text-red-600 font-semibold text-sm px-4 py-2 rounded"
                                    >
                                        Reset Counter
                                    </button>
                                ) : (
                                    <div className="flex justify-center gap-4 items-center animate-fade-in">
                                        <span className="text-red-600 font-bold">Are you sure?</span>
                                        <button 
                                            onClick={() => { updateCount(0); setConfirmReset(false); }}
                                            className="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600"
                                        >
                                            Yes, Reset to 0
                                        </button>
                                        <button 
                                            onClick={() => setConfirmReset(false)}
                                            className="text-gray-500 hover:text-gray-700"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <p className="text-center text-gray-400 mt-8 text-xs">
                            Bucket ID: {bucketKey}
                        </p>
                    </div>
                </div>
            );
        };

        // 4. Main App Orchestrator
        const App = () => {
            const [view, setView] = useState('setup'); // setup, display, admin
            const [bucketKey, setBucketKey] = useState(null);

            const handleSetupComplete = (key, mode) => {
                setBucketKey(key);
                setView(mode);
            };

            return (
                <React.StrictMode>
                    {view === 'setup' && <SetupScreen onComplete={handleSetupComplete} />}
                    {view === 'display' && <DisplayMode bucketKey={bucketKey} />}
                    {view === 'admin' && <AdminMode bucketKey={bucketKey} onLogout={() => setView('setup')} />}
                </React.StrictMode>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>