<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Awana Verse Counter</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800;900&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <!-- GreenSock (GSAP) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: #000;
        font-family: 'Poppins', sans-serif;
        -webkit-font-smoothing: antialiased;
      }
      #root {
        width: 100%;
        height: 100%;
      }
      /* Admin Modal Animation */
      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      /* Floating Icon Animation */
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
        100% { transform: translateY(0px); }
      }
    </style>

    <!-- Import Map: Use Google CDN for Firebase to ensure correct Service Registration -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"
      }
    }
    </script>
  </head>
  <body>
    <div id="root"></div>

    <!-- MAIN APP LOGIC -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from "react";
      import { createRoot } from "react-dom/client";
      import { initializeApp } from "firebase/app";
      import { getDatabase, ref, onValue, set } from "firebase/database";

      // --- CONFIGURATION ---
      const ADMIN_PIN = "1234"; // Simple protection for the event
      
      const AUDIO_URLS = {
        pop: "https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3",
        celebrate: "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3",
      };

      const THEMES = [
        {
          name: "Sunrise Savanna",
          gradient: "linear-gradient(135deg, #FF9966 0%, #FF5E62 100%)",
          textColor: "#FFFFFF",
          accentColor: "#FFD700",
          icon: "üåÖ",
          animationType: "drop",
        },
        {
          name: "River Crossing",
          gradient: "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
          textColor: "#FFFFFF",
          accentColor: "#003366",
          icon: "üåä",
          animationType: "slide",
        },
        {
          name: "Jungle Trek",
          gradient: "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)",
          textColor: "#FFFFFF",
          accentColor: "#0b4d0b",
          icon: "üå¥",
          animationType: "pop",
        },
        {
          name: "Village Build",
          gradient: "linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)",
          textColor: "#5D4037",
          accentColor: "#8D6E63",
          icon: "üèòÔ∏è",
          animationType: "spin",
        },
        {
          name: "Celebration Night",
          gradient: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
          textColor: "#FFD700",
          accentColor: "#E1BEE7",
          icon: "‚ú®",
          animationType: "zoom",
        },
      ];

      // --- FIREBASE INIT ---
      const firebaseConfig = {
        apiKey: "AIzaSyCk0TR4SUFUvsdpIDGmH-0CzbZQQcZBL30",
        authDomain: "awana-africa-tracker.firebaseapp.com",
        databaseURL: "https://awana-africa-tracker-default-rtdb.firebaseio.com",
        projectId: "awana-africa-tracker",
        storageBucket: "awana-africa-tracker.firebasestorage.app",
        messagingSenderId: "825987576771",
        appId: "1:825987576771:web:f293d618dad3ded2c70376",
        measurementId: "G-1SMFYMQMNW"
      };

      let db = null;
      let firebaseInitialized = false;

      try {
        const app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        firebaseInitialized = true;
        console.log("Firebase initialized successfully");
      } catch (e) {
        console.error("Firebase failed to load. Running in local offline mode.", e);
      }

      // --- COMPONENTS ---

      // 1. Start Overlay
      const StartOverlay = ({ onStart }) => {
        return (
          <div
            style={{
              position: "fixed",
              inset: 0,
              zIndex: 9999,
              backgroundColor: "rgba(0,0,0,0.9)",
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
              justifyContent: "center",
              color: "white",
              backdropFilter: "blur(10px)",
            }}
          >
            <h1 style={{ marginBottom: "20px", textAlign: "center", fontFamily: 'Poppins, sans-serif' }}>
              Awana Africa<br />Verse Counter
            </h1>
            <button
              onClick={onStart}
              style={{
                padding: "15px 40px",
                fontSize: "24px",
                backgroundColor: "#FFD700",
                color: "#333",
                border: "none",
                borderRadius: "50px",
                cursor: "pointer",
                fontWeight: "bold",
                boxShadow: "0 4px 15px rgba(255, 215, 0, 0.4)",
                transition: "transform 0.2s",
              }}
              onMouseEnter={(e) => (e.currentTarget.style.transform = "scale(1.05)")}
              onMouseLeave={(e) => (e.currentTarget.style.transform = "scale(1)")}
            >
              Start Broadcast
            </button>
            <p style={{ marginTop: "20px", opacity: 0.6 }}>Initializes Audio & Sync</p>
          </div>
        );
      };

      // 2. Admin Panel
      const AdminPanel = ({ currentCount, onUpdateCount, isOffline }) => {
        const [isOpen, setIsOpen] = useState(false);
        const [isAuthenticated, setIsAuthenticated] = useState(false);
        const [pinInput, setPinInput] = useState("");
        const [customVal, setCustomVal] = useState("");

        const handlePinSubmit = () => {
          if (pinInput === ADMIN_PIN) {
            setIsAuthenticated(true);
            setPinInput("");
          } else {
            alert("Incorrect PIN");
            setPinInput("");
          }
        };

        if (!isOpen) {
          return (
            <button
              onClick={() => setIsOpen(true)}
              style={{
                position: "fixed",
                bottom: "20px",
                right: "20px",
                width: "50px",
                height: "50px",
                borderRadius: "50%",
                backgroundColor: "rgba(255,255,255,0.2)",
                border: "none",
                cursor: "pointer",
                zIndex: 100,
                opacity: 0.4,
                transition: "all 0.3s",
                display: "flex",
                alignItems: "center",
                justifyContent: "center",
                fontSize: "24px",
                color: "white"
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.opacity = "1";
                e.currentTarget.style.backgroundColor = "rgba(255,255,255,0.4)";
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.opacity = "0.4";
                e.currentTarget.style.backgroundColor = "rgba(255,255,255,0.2)";
              }}
            >
              ‚öôÔ∏è
            </button>
          );
        }

        const containerStyle = {
          position: "fixed",
          bottom: "20px",
          right: "20px",
          backgroundColor: "white",
          padding: "20px",
          borderRadius: "15px",
          boxShadow: "0 10px 40px rgba(0,0,0,0.5)",
          zIndex: 101,
          color: "#333",
          width: "300px",
          animation: "slideUp 0.3s ease-out"
        };

        const adminButtonStyle = {
          padding: "10px",
          border: "none",
          borderRadius: "8px",
          backgroundColor: "#f0f0f0",
          cursor: "pointer",
          fontWeight: "600",
          transition: "all 0.2s",
          boxShadow: "0 2px 5px rgba(0,0,0,0.05)"
        };

        // Auth Screen
        if (!isAuthenticated) {
          return (
            <div style={containerStyle}>
              <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "15px" }}>
                <h3 style={{ margin: 0 }}>Admin Access</h3>
                <button onClick={() => setIsOpen(false)} style={{ border: "none", background: "none", cursor: "pointer" }}>‚úï</button>
              </div>
              <input 
                type="password" 
                value={pinInput}
                onChange={(e) => setPinInput(e.target.value)}
                placeholder="Enter PIN"
                style={{ width: "100%", padding: "10px", marginBottom: "10px", borderRadius: "8px", border: "1px solid #ccc", boxSizing: "border-box" }}
              />
              <button 
                onClick={handlePinSubmit}
                style={{ ...adminButtonStyle, width: "100%", backgroundColor: "#FFD700", color: "#333" }}
              >
                Unlock
              </button>
            </div>
          );
        }

        // Controls Screen
        return (
          <div style={containerStyle}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: "15px" }}>
              <h3 style={{ margin: 0 }}>Admin Control</h3>
              <button
                onClick={() => setIsOpen(false)}
                style={{ border: "none", background: "none", cursor: "pointer", fontSize: "16px", padding: "5px" }}
              >
                ‚úï
              </button>
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "10px", marginBottom: "15px" }}>
              <button
                onClick={() => onUpdateCount(currentCount + 1)}
                style={adminButtonStyle}
              >
                +1 Verse
              </button>
              <button
                onClick={() => onUpdateCount(currentCount + 5)}
                style={adminButtonStyle}
              >
                +5 Verses
              </button>
            </div>

            <div style={{ display: "flex", gap: "10px", marginBottom: "15px" }}>
              <input
                type="number"
                placeholder="Custom Amount"
                value={customVal}
                onChange={(e) => setCustomVal(e.target.value)}
                style={{
                  flex: 1,
                  padding: "8px",
                  border: "1px solid #ccc",
                  borderRadius: "5px",
                  fontSize: "16px"
                }}
              />
              <button
                onClick={() => {
                   const val = parseInt(customVal);
                   if(!isNaN(val)) onUpdateCount(currentCount + val);
                   setCustomVal("");
                }}
                style={adminButtonStyle}
              >
                Add
              </button>
            </div>

            <button
              onClick={() => {
                if (confirm("Are you sure you want to RESET the count to 0?")) {
                  onUpdateCount(0);
                }
              }}
              style={{ ...adminButtonStyle, backgroundColor: "#ff4444", color: "white" }}
            >
              Reset Counter
            </button>

            <div style={{ marginTop: "15px", fontSize: "12px", color: "#888", textAlign: "center", display: "flex", alignItems: "center", justifyContent: "center", gap: "6px" }}>
              <span style={{ width: "8px", height: "8px", borderRadius: "50%", backgroundColor: isOffline ? "#ff4444" : "#00C851" }}></span>
              {isOffline ? "Offline Mode (Local Only)" : "Connected to Database"}
            </div>
          </div>
        );
      };

      // 3. Main App
      const App = () => {
        const [hasStarted, setHasStarted] = useState(false);
        const [count, setCount] = useState(0);
        const [prevCount, setPrevCount] = useState(0);
        const [isOffline, setIsOffline] = useState(!firebaseInitialized);
        
        const numberRef = useRef(null);
        const bgRef = useRef(null);
        const audioContextRef = useRef(null);
        const popBufferRef = useRef(null);
        const celebrateBufferRef = useRef(null);

        const themeIndex = Math.min(Math.floor(count / 100), THEMES.length - 1);
        const currentTheme = THEMES[themeIndex] || THEMES[0];

        // Init Audio
        const initAudio = async () => {
          try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContextRef.current = new AudioContext();

            const loadSound = async (url) => {
              try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                return await audioContextRef.current.decodeAudioData(arrayBuffer);
              } catch (e) {
                console.warn("Audio load failed", e);
                return null;
              }
            };

            popBufferRef.current = await loadSound(AUDIO_URLS.pop);
            celebrateBufferRef.current = await loadSound(AUDIO_URLS.celebrate);
          } catch (e) {
            console.error("Audio init error", e);
          }
          setHasStarted(true);
        };

        const playSound = (type) => {
          if (!audioContextRef.current) return;
          
          if (audioContextRef.current.state === "suspended") {
            audioContextRef.current.resume();
          }

          const buffer = type === "pop" ? popBufferRef.current : celebrateBufferRef.current;
          if (buffer) {
            const source = audioContextRef.current.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContextRef.current.destination);
            source.start(0);
          }
        };

        // Firebase Sync
        useEffect(() => {
          if (!db) {
            setIsOffline(true);
            return;
          }

          try {
            const countRef = ref(db, "verse_count");
            const unsubscribe = onValue(countRef, (snapshot) => {
              setIsOffline(false);
              const val = snapshot.val();
              // Only update if valid number
              if (typeof val === 'number') {
                setCount((prev) => {
                  setPrevCount(prev);
                  return val;
                });
              }
            }, (error) => {
              console.error("Firebase Read Error:", error);
              setIsOffline(true);
            });
            return () => unsubscribe();
          } catch (err) {
            console.error("Firebase Connection Error:", err);
            setIsOffline(true);
          }
        }, []);

        // Update Handler
        const handleUpdateCount = (newValue) => {
          setPrevCount(count);
          setCount(newValue);

          if (db && !isOffline) {
            set(ref(db, "verse_count"), newValue).catch((err) => {
              console.error("Failed to sync to firebase, staying local", err);
              setIsOffline(true);
            });
          }
        };

        // Animations
        useEffect(() => {
          if (!hasStarted) return;
          if (count === prevCount) return;

          const isLevelUp = Math.floor(count / 100) > Math.floor(prevCount / 100);
          const isIncrease = count > prevCount;

          if (isLevelUp) playSound("celebrate");
          else if (isIncrease) playSound("pop");

          if (numberRef.current && window.gsap) {
            const tl = window.gsap.timeline();
            window.gsap.set(numberRef.current, { clearProps: "all" });

            switch (currentTheme.animationType) {
              case "drop":
                 tl.fromTo(numberRef.current, 
                   { y: -100, opacity: 0, scale: 1.5 }, 
                   { y: 0, opacity: 1, scale: 1, duration: 0.8, ease: "bounce.out" }
                 );
                 break;
              case "slide":
                tl.fromTo(numberRef.current,
                  { x: 200, opacity: 0, skewX: -20 },
                  { x: 0, opacity: 1, skewX: 0, duration: 0.6, ease: "power2.out" }
                );
                break;
              case "pop":
                tl.fromTo(numberRef.current,
                  { scale: 0, rotation: -45 },
                  { scale: 1, rotation: 0, duration: 0.6, ease: "elastic.out(1, 0.5)" }
                );
                break;
              case "spin":
                tl.fromTo(numberRef.current,
                  { rotationY: 90, opacity: 0 },
                  { rotationY: 0, opacity: 1, duration: 0.8, ease: "back.out(1.7)" }
                );
                break;
              case "zoom":
              default:
                tl.fromTo(numberRef.current,
                  { scale: 3, opacity: 0, filter: "blur(10px)" },
                  { scale: 1, opacity: 1, filter: "blur(0px)", duration: 1, ease: "expo.out" }
                );
                break;
            }
          }
          
          if (count !== prevCount) {
              setPrevCount(count);
          }
        }, [count, hasStarted, currentTheme]);

        if (!hasStarted) {
          return <StartOverlay onStart={initAudio} />;
        }

        return (
          <div
            ref={bgRef}
            style={{
              width: "100%",
              height: "100%",
              background: currentTheme.gradient,
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
              justifyContent: "center",
              transition: "background 1s ease-in-out",
              position: "relative",
              overflow: "hidden",
            }}
          >
            {/* Background Icon */}
            <div
              style={{
                position: "absolute",
                fontSize: "50vh",
                opacity: 0.1,
                pointerEvents: "none",
                userSelect: "none",
                animation: "float 6s ease-in-out infinite",
              }}
            >
              {currentTheme.icon}
            </div>

            {/* Header */}
            <div
              style={{
                position: "absolute",
                top: "40px",
                textAlign: "center",
                color: currentTheme.textColor,
                opacity: 0.9,
                zIndex: 20
              }}
            >
              <h2 style={{ 
                margin: 0, 
                fontSize: "2rem", 
                textTransform: "uppercase", 
                letterSpacing: "4px",
                textShadow: "0 2px 10px rgba(0,0,0,0.2)"
              }}>
                Verses Recited
              </h2>
              <div style={{ marginTop: "10px", fontSize: "1.2rem", fontWeight: "600" }}>
                 {currentTheme.name} Era
              </div>
            </div>

            {/* Counter */}
            <div
              ref={numberRef}
              style={{
                fontSize: "15rem",
                fontWeight: "900",
                fontFamily: "'Nunito', sans-serif",
                color: currentTheme.textColor,
                textShadow: `0 10px 30px rgba(0,0,0,0.3), 4px 4px 0px ${currentTheme.accentColor}`,
                zIndex: 10,
                lineHeight: 1,
                cursor: "default",
                userSelect: "none"
              }}
            >
              {count}
            </div>

            {/* Admin */}
            <AdminPanel 
              currentCount={count} 
              onUpdateCount={handleUpdateCount} 
              isOffline={isOffline}
            />
          </div>
        );
      };

      // MOUNT
      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>